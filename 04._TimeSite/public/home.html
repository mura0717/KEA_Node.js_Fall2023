<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm Alarm Alarm</title>
    
    <style>
        .blink {
      animation: blinker 1s linear infinite;
      background:red;
      color:white;
      width: 280px;
      font-size: xx-large;
      font-weight:bold;
    }
    
    @keyframes blinker {
      50% {
        opacity: 0;
      }
    }
      </style>

</head>
<body>

    <img src="https://media2.giphy.com/media/oFfNvh4r621WxqrzZb/giphy.gif?cid=ecf05e47g6dg8hly26ose7s9339pr2h6arrwvzre8s1um1t1&ep=v1_gifs_search&rid=giphy.gif&ct=g" style="float: right;">
    <div class="blink">Alarm Alarm Alarm</div>

    <!-- Create a new alarm -->
    <h2>Create a new alarm</h2>
    <input type="time" id="newAlarm">
    <button onclick="createAlarm()">Create Alarm</button>

     <!-- Get a specific alarm -->
     <h2>Get a specific alarm</h2>
     <input type="number" id="getAlarmId" placeholder="Alarm Id">
     <button onclick="getAlarm()">Get Alarm</button>
     <div id="specificAlarm"></div>

    <!-- Get all alarms -->
    <h2>Get all alarms</h2>
    <button onclick="getAllAlarms()">Get All Alarms</button>
    <ul id="allAlarms"></ul>

    <!-- Edit an alarm -->
    <h2>Edit an alarm</h2>
    <input type="number" id="editAlarmId" placeholder="Alarm Id">
    <input type="time" id="editedAlarmTime">
    <button onclick="editAlarm()">Edit Alarm</button>

    <!-- Delete an alarm -->
    <h2>Delete an alarm</h2>
    <input type="number" id="deleteAlarmId" placeholder="Alarm Id">
    <button onclick="deleteAlarm()">Delete Alarm</button>


   
</body>

<script>

    function playAlarm(time){

        const maxPlayTime = 10000; //Alarm duration: 10 sec.
        const dateObject = new Date();

        let beep = new Audio('https://www.soundjay.com/buttons/sounds/beep-07a.mp3');
        beep.loop = true;
        setTimeout(() => {
            beep.play();
            setTimeout(() => { //stopping the alarm and resetting.
                beep.pause();
                //beep.currentTime = 0;
            }, maxPlayTime);
        }, time);
    }

    function alarmHoursConverter(alarm){
        const alarmDetails = alarm;
        const [hours, minutes] = alarmDetails.split(":").map(Number);

        const hoursInMilliseconds = hours * 3600000; // 1 hour = 3600000 milliseconds
        const minutesInMilliseconds = minutes * 60000;

        return hoursInMilliseconds+minutesInMilliseconds;
    }

    function currentHoursConverter(){

        const newDateObject = new Date();
        const currentHours = newDateObject.getHours();
        //console.log(currentHours);
        const currentMinutes = newDateObject.getMinutes();
        //console.log(currentMinutes);

        const currentHoursInMilliseconds = currentHours * 3600000; // 1 hour = 3600000 milliseconds
        const currentMinutesInMilliseconds = currentMinutes * 60000;

        return currentHoursInMilliseconds + currentMinutesInMilliseconds;

    }

    async function createAlarm() {
        const newAlarm = document.getElementById("newAlarm").value;

        if (!newAlarm) {
        alert("Please provide a time for the alarm.");
        return;
        }

        const res = await fetch ("/alarms", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({alarm: newAlarm})
        })
        const data = await res.json();
        alert(`Alarm created with Id: ${data.data.id} and time: ${data.data.alarm}`);

        const alarmTime = alarmHoursConverter(newAlarm);
        const currentTime = currentHoursConverter();
        const timeDelay = alarmTime - currentTime; 
        playAlarm(timeDelay);
    }
    

    async function getAlarm() {
        const alarmId = document.getElementById("getAlarmId").value;
        const res = await fetch (`/alarms/${alarmId}`);
        const data = await res.json();

        const specificAlarm = document.getElementById("specificAlarm")
        specificAlarm.innerHTML =''; //clears textContent

        if (data.alarm){
            const alarmProperties = Object.entries(data.alarm)
                .map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`)
                .join(", ");
            document.getElementById("specificAlarm").textContent = `${alarmProperties}`;
        } else {
            document.getElementById("specificAlarm").textContent = "Alarm not found.";
        }
    }

    async function getAllAlarms() {
        const allAlarms = document.getElementById("allAlarms");
        const res = await fetch (`/alarms`);
        const data = await res.json();

        allAlarms.innerHTML =''; //clears textContent

        if (data.alarms.length === 0) {
            allAlarms.textContent = "No alarms yet.";
        }

        if (data && data.alarms) {
            data.alarms.forEach((alarm) => {
            const alarmProperties = Object.entries(alarm)
                .map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`)
                .join(", ");
            const listItem = document.createElement("li");
            listItem.textContent = `${alarmProperties}`;
            allAlarms.appendChild(listItem);
        });
        } else {
            allAlarms.textContent = "Error populating alarms' list.";
             };
        }

    async function editAlarm() {
        const editAlarmId = document.getElementById("editAlarmId").value;
        const editedTime = document.getElementById("editedAlarmTime").value;
        
        const res = await fetch (`/alarms/${editAlarmId}`);
        const data = await res.json();

        if (res.status === 404) {
        alert("Alarm not found.");
        return;
        }

        if (!editedTime) {
        alert("Please provide a new time for the alarm.");
        return;
        }

        const updatedAlarm = {...data.alarms, alarm: editedTime};
        const patchRes = await fetch(`/alarms/${editAlarmId}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updatedAlarm),
        });

        if (patchRes.status === 200) {
        alert(`Alarm with Id: ${editAlarmId} edited to ${editedTime}`);
        } else {
        alert("Failed to edit the alarm.");
        }
    }

    async function deleteAlarm() {
        const deleteAlarmId = document.getElementById("deleteAlarmId").value;
        const res = await fetch (`/alarms/${deleteAlarmId}`);
        const data = await res.json();

        if (res.status === 404) {
        alert("Alarm not found.");
        return;
        }

        if(data.alarm){
            const alarmProperties = Object.entries(data.alarm)
                .map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`)
                .join(", with ");

            const deleteRes = await fetch(`/alarms/${deleteAlarmId}`, {
            method: "DELETE",
        });

        if (deleteRes.status === 200) {
            alert(`${alarmProperties} is deleted.`);
        } else {
            alert("Failed to delete the alarm.");
        }
    }
}
</script>
</html>